---
title: "Analysis Output"
author: "Xuanyu Lyu"
date: "9/29/2022"
output: html_document
---

```{r setup, include=FALSE}
source("data_prep.R")
knitr::opts_chunk$set(echo = TRUE)
library(psych)
library(broom)
library(standardize)

# functions
prettify_regression_results <- function(regression_object,standardize=FALSE) {
    if(!standardize){
      regression_object %>%
        gtsummary::tbl_regression(intercept=TRUE, 
                                  pvalue_fun = ~ gtsummary::style_pvalue(.x, digits = 3),
                                  estimate_fun = ~ gtsummary::style_sigfig(.x, digits = 3),
                                  tidy_fun = gtsummary::tidy_standardize(.x))%>%
          gtsummary::add_glance_source_note(
              label = list(statistic ~ "F-statistic",
                           df  ~ "DF1",
                           df.residual  ~ "DF2"),
              include = c(r.squared, statistic, df, df.residual, p.value, nobs)
          ) %>%
          gtsummary::modify_header(
              statistic ~ "**t-statistic**", p.value ~ "**p-value**"
          )}else{ # not standardize
    
       regression_object %>%
            gtsummary::tbl_regression(intercept=TRUE, 
                                      pvalue_fun = ~ gtsummary::style_pvalue(.x, digits = 3),
                                      estimate_fun = ~ gtsummary::style_sigfig(.x, digits = 3)
            ) %>%
        gtsummary::add_glance_source_note(
            label = list(statistic ~ "F-statistic",
                         df  ~ "DF1",
                         df.residual  ~ "DF2"),
            include = c(r.squared, statistic, df, df.residual, p.value, nobs)
        ) %>%
        gtsummary::modify_header(
            statistic ~ "**t-statistic**", p.value ~ "**p-value**"
        )
            }}

## this is still broken because of the standardized beta toggle. needs to be fixed!!!!
```

## Output


```{r dataprep}
# run discord model
cor_output <- df_target_c %>%
  select(mathtest18, CFPS2018EDUY_IM, MH) %>%
  corr.test(use = "complete")

print(cor_output$stars,quote=FALSE)

print(cor_output$ci,quote=FALSE,digits=5)



df_final <- discord_data(data = df_links_clean,
             outcome = "MH",
             predictors = c("mathtest18",
                            "edu",
                            "birthyear"),
             id = "rowid",
             sex = NULL,
             race = NULL,
             pair_identifiers = c("_S1", "_S2"),
             demographics = "none")



```

### Mental Health ~ Education + Age + Mathtest

```{r analysis}
# mathtest 
lm(MH_mean ~ edu_mean + birthyear_mean + 
       mathtest18_mean,
   data = df_final) |> prettify_regression_results()

lm(MH_diff ~ edu_mean + birthyear_mean + MH_mean + 
       mathtest18_mean + mathtest18_diff,
   data = df_final) |> prettify_regression_results()


discord_regression(data = df_links_clean,
             outcome = "MH",
             predictors = c("mathtest18",
                            "edu",
                            "birthyear"),
             id = "rowid",
             sex = NULL,
             race = NULL,
             pair_identifiers = c("_S1", "_S2"))|> prettify_regression_results()
```


