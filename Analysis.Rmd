---
title: "Analysis Output"
author: "Xuanyu Lyu"
date: "9/29/2022"
output: html_document
---

```{r setup, include=FALSE}
source("data_prep.R")
knitr::opts_chunk$set(echo = TRUE)
library(psych)
library(broom)
library(standardize)
library(gtsummary)
```
```{r function}
# functions
prettify_regression_results <- function(regression_object,
                                        intercept=TRUE,
                                        standardize=FALSE) {
										
temp <-  regression_object %>%
            gtsummary::tbl_regression(intercept=intercept, 
                                      pvalue_fun = ~ gtsummary::style_pvalue(.x, digits = 3),
                                      estimate_fun = ~ gtsummary::style_sigfig(.x, digits = 3)
            ) %>%
        gtsummary::modify_header(
            statistic ~ "**t-statistic**", p.value ~ "**p-value**"
        ) %>%
        gtsummary::add_glance_source_note(
            label = list(statistic ~ "F-statistic",
                         df  ~ "DF1",
                         df.residual  ~ "DF2"),
            include = c(r.squared, statistic, df, df.residual, p.value, nobs)
        )

if(standardize){
temp_stnd <-      regression_object %>%
        gtsummary::tbl_regression(intercept=intercept, 
                                  estimate_fun = ~ gtsummary::style_sigfig(.x, digits = 3),
                                  pvalue_fun = ~ gtsummary::style_pvalue(.x, digits = 3),
                                  tidy_fun = gtsummary::tidy_standardize,
								  conf.int=FALSE) %>%
        gtsummary::modify_header(
            estimate ~ "**Î²**"
        ) 

temp <-
  tbl_merge(
    list(temp_stnd, temp),
    tab_spanner = c("**Standardized**", "** **")
  )
}
temp  
}


## this is still broken because of the standardized beta toggle. needs to be fixed!!!! it doesn't include p-values



```

## Output


```{r dataprep}
# run discord model
cor_output <- df_target_c %>%
  select(mathtest18, CFPS2018EDUY_IM, MH) %>%
  corr.test(use = "complete")

print(cor_output$stars,quote=FALSE)

print(cor_output$ci,quote=FALSE,digits=5)



df_final <- discord_data(data = df_links_clean,
             outcome = "MH",
             predictors = c("mathtest18",
                            "edu",
                            "birthyear"),
             id = "rowid",
             sex = NULL,
             race = NULL,
             pair_identifiers = c("_S1", "_S2"),
             demographics = "none")



```

### Mental Health ~ Education + Age + Mathtest

```{r analysis}
# mathtest 
lm(MH_mean ~ edu_mean + birthyear_mean + 
       mathtest18_mean,
   data = df_final) |> prettify_regression_results(standardize=TRUE)

lm(MH_diff ~ edu_mean + birthyear_mean + MH_mean + 
       mathtest18_mean + mathtest18_diff,
   data = df_final) |> prettify_regression_results()


discord_regression(data = df_links_clean,
             outcome = "MH",
             predictors = c("mathtest18",
                            "edu",
                            "birthyear"),
             id = "rowid",
             sex = NULL,
             race = NULL,
             pair_identifiers = c("_S1", "_S2"))|> prettify_regression_results()
```


